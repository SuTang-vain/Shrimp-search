# Shrimp Agent 项目依赖关系可视化文档

## 1. 项目整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Shrimp Agent v1.0                       │
│                     多模态RAG智能搜索系统                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端层 (UI)    │    │   API服务层      │    │   业务逻辑层     │
│                │    │                │    │                │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ index.html  │ │    │ │api_server_v2│ │    │ │Enhanced_RAG │ │
│ │ script.js   │ │◄───┤ │.py          │ │◄───┤ │_v2.py       │ │
│ │ style.css   │ │    │ │             │ │    │ │             │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│ ┌─────────────┐ │    │                │    │                │
│ │frontend/    │ │    │                │    │                │
│ │server.py    │ │    │                │    │                │
│ └─────────────┘ │    │                │    │                │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                              ▼                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                        核心模块层                                │
│                                                               │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │LLM接口模块   │ │多模态处理    │ │文档管理     │ │网页研究     │ │
│ │             │ │模块         │ │模块         │ │模块         │ │
│ │enhanced_llm │ │enhanced_    │ │enhanced_    │ │enhanced_web │ │
│ │_interface   │ │multimodal_  │ │document_    │ │_research    │ │
│ │_v2.py       │ │processor.py │ │manager.py   │ │.py          │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
│                                                               │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │模型管理     │ │Ollama接口   │ │用户界面     │ │性能监控     │ │
│ │模块         │ │模块         │ │模块         │ │模块         │ │
│ │model_       │ │ollama_      │ │enhanced_    │ │performance_ │ │
│ │manager.py   │ │interface.py │ │user_        │ │monitor.py   │ │
│ │             │ │             │ │interface_v2 │ │             │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据存储层                                │
│                                                               │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │向量数据库   │ │文档缓存     │ │模型配置     │ │性能数据     │ │
│ │(FAISS)      │ │(本地文件)   │ │(JSON)       │ │(内存/文件)  │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 核心模块详细依赖关系图

### 2.1 主程序依赖关系

```
api_server_v2.py (主API服务器)
├── Enhanced_Interactive_Multimodal_RAG_v2.py
│   ├── enhanced_llm_interface_v2.py
│   │   ├── model_manager.py
│   │   └── ollama_interface.py
│   ├── enhanced_user_interface_v2.py
│   ├── enhanced_multimodal_processor.py
│   ├── enhanced_web_research.py
│   ├── enhanced_document_manager.py
│   └── performance_monitor.py
├── flask (Web框架)
├── flask_cors (跨域支持)
└── threading (异步处理)

frontend/server.py (前端服务器)
├── http.server (HTTP服务)
├── socketserver (Socket服务)
└── webbrowser (浏览器控制)

Enhanced_Interactive_Multimodal_RAG_v2.py (核心RAG系统)
├── enhanced_llm_interface_v2.py
├── enhanced_user_interface_v2.py
├── enhanced_multimodal_processor.py
├── enhanced_web_research.py
├── enhanced_document_manager.py
├── performance_monitor.py
├── sentence_transformers (嵌入模型)
├── faiss (向量数据库)
└── numpy (数值计算)
```

### 2.2 Enhanced模块内部依赖

```
enhanced_llm_interface_v2.py
├── model_manager.py
│   ├── json (配置管理)
│   ├── os (环境变量)
│   └── typing (类型注解)
├── ollama_interface.py
│   ├── requests (HTTP请求)
│   ├── json (数据处理)
│   └── logging (日志记录)
├── openai (API调用)
├── dashscope (ModelScope API)
└── logging (日志记录)

enhanced_multimodal_processor.py
├── PIL (图像处理)
├── pytesseract (OCR)
├── pymupdf (PDF处理)
├── unstructured (文档解析)
├── pandas (表格处理)
└── cv2 (计算机视觉)

enhanced_web_research.py
├── duckduckgo_search (搜索引擎)
├── requests (HTTP请求)
├── beautifulsoup4 (HTML解析)
├── concurrent.futures (并发处理)
└── urllib (URL处理)

enhanced_document_manager.py
├── pathlib (路径处理)
├── hashlib (文件哈希)
├── pickle (序列化)
├── docx (Word文档)
├── openpyxl (Excel文档)
└── markdown (Markdown处理)
```

## 3. 分层架构详细说明

### 3.1 前端层 (Frontend Layer)
```
┌─────────────────────────────────────────────────────────────┐
│                        前端层                                │
├─────────────────────────────────────────────────────────────┤
│ 组件                │ 功能                │ 端口            │
├─────────────────────┼─────────────────────┼─────────────────┤
│ index.html          │ 主页面结构          │ -               │
│ script.js           │ 交互逻辑            │ -               │
│ style.css           │ 样式定义            │ -               │
│ frontend/server.py  │ 静态文件服务        │ 8080            │
└─────────────────────┴─────────────────────┴─────────────────┘

数据流向: 用户交互 → JavaScript → API请求 → 后端服务
```

### 3.2 API服务层 (API Service Layer)
```
┌─────────────────────────────────────────────────────────────┐
│                      API服务层                              │
├─────────────────────────────────────────────────────────────┤
│ 组件                │ 功能                │ 端口            │
├─────────────────────┼─────────────────────┼─────────────────┤
│ api_server_v2.py    │ RESTful API服务     │ 5000            │
│ ├─ /api/health      │ 健康检查            │ GET             │
│ ├─ /api/models      │ 模型管理            │ GET/POST        │
│ ├─ /api/search      │ 搜索服务            │ POST            │
│ ├─ /api/upload      │ 文件上传            │ POST            │
│ └─ /api/knowledge   │ 知识库管理          │ GET/POST/DELETE │
└─────────────────────┴─────────────────────┴─────────────────┘

数据流向: HTTP请求 → Flask路由 → 业务逻辑 → 响应数据
```

### 3.3 业务逻辑层 (Business Logic Layer)
```
┌─────────────────────────────────────────────────────────────┐
│                     业务逻辑层                               │
├─────────────────────────────────────────────────────────────┤
│ 核心组件            │ 主要功能                              │
├─────────────────────┼─────────────────────────────────────┤
│ EnhancedRAGSystemV2 │ RAG系统核心调度                     │
│ ├─ 查询处理         │ 用户查询理解与优化                   │
│ ├─ 向量检索         │ 文档相似度搜索                       │
│ ├─ 内容生成         │ LLM响应生成                         │
│ └─ 结果整合         │ 多源信息融合                         │
├─────────────────────┼─────────────────────────────────────┤
│ EnhancedLLMInterfaceV2 │ 多模型统一接口                   │
│ ├─ 模型选择         │ 自动/手动模型切换                   │
│ ├─ API调用          │ ModelScope/Ollama调用               │
│ ├─ 错误处理         │ 重试机制与降级策略                   │
│ └─ 性能优化         │ 缓存与并发控制                       │
└─────────────────────┴─────────────────────────────────────┘
```

### 3.4 数据处理层 (Data Processing Layer)
```
┌─────────────────────────────────────────────────────────────┐
│                     数据处理层                               │
├─────────────────────────────────────────────────────────────┤
│ 处理模块            │ 支持格式            │ 主要功能        │
├─────────────────────┼─────────────────────┼─────────────────┤
│ 多模态处理器        │ PDF, DOCX, TXT      │ 文档解析        │
│                    │ MD, CSV, XLSX       │ 内容提取        │
│                    │ PNG, JPG, GIF       │ OCR识别         │
├─────────────────────┼─────────────────────┼─────────────────┤
│ 文档管理器          │ 所有支持格式        │ 缓存管理        │
│                    │                     │ 增量更新        │
│                    │                     │ 元数据管理      │
├─────────────────────┼─────────────────────┼─────────────────┤
│ 网页研究器          │ HTML, XML           │ 网页抓取        │
│                    │ JSON, RSS           │ 内容分析        │
│                    │                     │ 信息提取        │
└─────────────────────┴─────────────────────┴─────────────────┘
```

## 4. 数据流向分析

### 4.1 用户查询流程
```
用户输入查询
      │
      ▼
┌─────────────┐    HTTP POST     ┌─────────────┐
│  前端界面    │ ──────────────► │ API服务器   │
│ (script.js) │                │(api_server  │
└─────────────┘                │_v2.py)      │
                               └─────────────┘
                                      │
                                      ▼
                               ┌─────────────┐
                               │ RAG系统核心 │
                               │(Enhanced_   │
                               │RAG_v2.py)   │
                               └─────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
            ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
            │ 向量检索    │   │ 网页搜索    │   │ LLM生成     │
            │ (FAISS)     │   │ (DuckDuck   │   │ (ModelScope │
            │             │   │ Go)         │   │ /Ollama)    │
            └─────────────┘   └─────────────┘   └─────────────┘
                    │                 │                 │
                    └─────────────────┼─────────────────┘
                                      ▼
                               ┌─────────────┐
                               │ 结果整合    │
                               │ 与返回      │
                               └─────────────┘
                                      │
                                      ▼
                               ┌─────────────┐
                               │ JSON响应    │
                               │ 返回前端    │
                               └─────────────┘
```

### 4.2 文档上传流程
```
用户选择文件
      │
      ▼
┌─────────────┐   FormData      ┌─────────────┐
│  文件选择    │ ──────────────► │ 文件上传API │
│  (前端)      │                │ (/api/upload)│
└─────────────┘                └─────────────┘
                                      │
                                      ▼
                               ┌─────────────┐
                               │ 文件保存    │
                               │ (uploads/)  │
                               └─────────────┘
                                      │
                                      ▼
                               ┌─────────────┐
                               │ 多模态处理  │
                               │ (enhanced_  │
                               │ multimodal) │
                               └─────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
            ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
            │ 文本提取    │   │ 图像OCR     │   │ 表格解析    │
            │             │   │             │   │             │
            └─────────────┘   └─────────────┘   └─────────────┘
                    │                 │                 │
                    └─────────────────┼─────────────────┘
                                      ▼
                               ┌─────────────┐
                               │ 向量化存储  │
                               │ (FAISS)     │
                               └─────────────┘
                                      │
                                      ▼
                               ┌─────────────┐
                               │ 缓存更新    │
                               │ (文档管理器) │
                               └─────────────┘
```

### 4.3 模型管理流程
```
模型操作请求
      │
      ▼
┌─────────────┐                ┌─────────────┐
│ 前端模型    │ ──────────────► │ 模型管理API │
│ 管理界面    │                │ (/api/models)│
└─────────────┘                └─────────────┘
                                      │
                                      ▼
                               ┌─────────────┐
                               │ 模型管理器  │
                               │ (model_     │
                               │ manager.py) │
                               └─────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
            ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
            │ 本地模型    │   │ 远程模型    │   │ 配置管理    │
            │ (Ollama)    │   │ (ModelScope)│   │ (JSON)      │
            └─────────────┘   └─────────────┘   └─────────────┘
                    │                 │                 │
                    └─────────────────┼─────────────────┘
                                      ▼
                               ┌─────────────┐
                               │ 状态更新    │
                               │ 与响应      │
                               └─────────────┘
```

## 5. 启动顺序图

```
启动脚本 (start_shrimp_agent_v1.0.bat)
│
├─ 1. 环境检查
│  ├─ 检查Python环境
│  ├─ 检查依赖包
│  └─ 检查端口占用
│
├─ 2. 停止现有进程
│  ├─ 终止5000端口进程 (API服务器)
│  └─ 终止8080端口进程 (前端服务器)
│
├─ 3. 启动后端服务
│  │
│  └─ python api_server_v2.py
│     │
│     ├─ 3.1 加载环境变量 (.env)
│     ├─ 3.2 初始化Flask应用
│     ├─ 3.3 配置CORS
│     ├─ 3.4 初始化RAG系统
│     │   ├─ 加载性能监控器
│     │   ├─ 初始化LLM接口
│     │   │   ├─ 加载模型管理器
│     │   │   └─ 初始化Ollama接口
│     │   ├─ 加载嵌入模型
│     │   ├─ 初始化多模态处理器
│     │   ├─ 初始化网页研究器
│     │   ├─ 初始化文档管理器
│     │   └─ 初始化用户界面
│     ├─ 3.5 注册API路由
│     └─ 3.6 启动Flask服务器 (端口5000)
│
├─ 4. 启动前端服务
│  │
│  └─ python frontend/server.py
│     │
│     ├─ 4.1 检查端口可用性
│     ├─ 4.2 配置HTTP服务器
│     ├─ 4.3 设置静态文件服务
│     └─ 4.4 启动HTTP服务器 (端口8080)
│
├─ 5. 打开浏览器
│  └─ 自动打开 http://localhost:8080
│
└─ 6. 系统就绪
   ├─ 前端界面可访问
   ├─ API服务可调用
   └─ 所有功能模块已加载
```

## 6. 模块间通信协议

### 6.1 HTTP API通信
```
前端 ←→ API服务器
│
├─ Content-Type: application/json
├─ 请求方法: GET, POST, DELETE
├─ 响应格式: JSON
└─ 错误处理: HTTP状态码 + 错误信息

示例请求:
POST /api/search
{
  "query": "用户查询内容",
  "use_web_search": true,
  "max_results": 5
}

示例响应:
{
  "success": true,
  "data": {
    "answer": "生成的回答",
    "sources": [...],
    "processing_time": 2.5
  }
}
```

### 6.2 内部模块通信
```
RAG系统核心 ←→ 各功能模块
│
├─ 方法调用: 直接函数调用
├─ 数据传递: Python对象
├─ 错误处理: 异常机制
└─ 日志记录: 统一日志格式

通信流程:
1. RAG系统接收查询
2. 调用LLM接口优化查询
3. 并行调用向量检索和网页搜索
4. 调用LLM接口生成回答
5. 返回整合结果
```

### 6.3 外部服务通信
```
LLM接口 ←→ 外部AI服务
│
├─ ModelScope API
│  ├─ 协议: HTTPS
│  ├─ 认证: API Key
│  ├─ 格式: JSON
│  └─ 重试: 指数退避
│
└─ Ollama本地服务
   ├─ 协议: HTTP
   ├─ 端口: 11434
   ├─ 格式: JSON
   └─ 健康检查: /api/tags
```

## 7. 关键路径分析

### 7.1 性能关键路径
```
用户查询 → 查询优化 → 向量检索 → LLM生成 → 结果返回
   │         │         │         │         │
  50ms     200ms     300ms     2000ms    100ms
   │         │         │         │         │
   └─────────┴─────────┴─────────┴─────────┘
                总耗时: ~2.65秒

优化点:
1. 查询优化: 缓存常见查询模式
2. 向量检索: 使用GPU加速FAISS
3. LLM生成: 流式响应减少感知延迟
4. 并行处理: 向量检索与网页搜索并行
```

### 7.2 可靠性关键路径
```
API请求 → 参数验证 → 业务处理 → 错误处理 → 响应返回
   │         │         │         │         │
 必须      必须      核心      关键      必须
   │         │         │         │         │
   └─────────┴─────────┴─────────┴─────────┘

风险点:
1. 外部API失效: 多模型降级机制
2. 向量数据库损坏: 自动重建机制
3. 内存不足: 分批处理大文档
4. 网络超时: 重试与超时控制
```

### 7.3 扩展性关键路径
```
新功能需求 → 模块设计 → 接口定义 → 实现集成 → 测试部署
     │         │         │         │         │
   分析      设计      标准      开发      验证
     │         │         │         │         │
     └─────────┴─────────┴─────────┴─────────┘

扩展点:
1. 新文档格式: 扩展多模态处理器
2. 新LLM模型: 扩展模型管理器
3. 新搜索引擎: 扩展网页研究器
4. 新存储后端: 扩展文档管理器
```

## 8. 依赖风险评估

### 8.1 高风险依赖
```
┌─────────────────┬─────────────┬─────────────┬─────────────┐
│ 依赖组件        │ 风险等级    │ 影响范围    │ 缓解措施    │
├─────────────────┼─────────────┼─────────────┼─────────────┤
│ ModelScope API  │ 高          │ 核心功能    │ Ollama降级  │
│ Ollama服务      │ 中          │ 本地推理    │ API降级     │
│ FAISS向量库     │ 高          │ 检索功能    │ 重建机制    │
│ 网络连接        │ 中          │ 网页搜索    │ 缓存机制    │
│ 文件系统        │ 低          │ 文档存储    │ 备份恢复    │
└─────────────────┴─────────────┴─────────────┴─────────────┘
```

### 8.2 依赖版本兼容性
```
核心依赖版本要求:
├─ Python >= 3.8
├─ Flask >= 2.0.0
├─ sentence-transformers >= 2.2.0
├─ faiss-cpu >= 1.7.0
├─ requests >= 2.25.0
├─ numpy >= 1.21.0
└─ openai >= 1.0.0

兼容性风险:
1. Python版本升级可能影响依赖包
2. FAISS版本变更可能影响索引格式
3. OpenAI API变更可能影响调用方式
```

### 8.3 性能瓶颈依赖
```
性能瓶颈分析:
├─ CPU密集型: 文档处理、向量计算
├─ 内存密集型: 向量索引、模型加载
├─ IO密集型: 文件读写、网络请求
└─ 网络依赖型: API调用、网页抓取

优化策略:
1. 异步处理减少阻塞
2. 缓存机制减少重复计算
3. 分批处理控制内存使用
4. 连接池复用网络连接
```

## 9. 监控和维护建议

### 9.1 关键指标监控
```
系统健康指标:
├─ API响应时间 (目标: <3秒)
├─ 内存使用率 (目标: <80%)
├─ CPU使用率 (目标: <70%)
├─ 错误率 (目标: <1%)
└─ 并发用户数 (监控峰值)

业务指标:
├─ 查询成功率
├─ 文档处理成功率
├─ 模型切换频率
└─ 用户满意度
```

### 9.2 日志管理策略
```
日志级别:
├─ ERROR: 系统错误、API失败
├─ WARNING: 性能警告、降级事件
├─ INFO: 关键操作、状态变更
└─ DEBUG: 详细调试信息

日志轮转:
├─ 文件大小: 100MB
├─ 保留天数: 30天
├─ 压缩存储: gzip
└─ 异步写入: 避免阻塞
```

### 9.3 备份和恢复
```
备份策略:
├─ 配置文件: 每日备份
├─ 向量索引: 每周备份
├─ 文档缓存: 按需备份
└─ 用户数据: 实时同步

恢复流程:
1. 检测故障类型
2. 选择恢复策略
3. 执行恢复操作
4. 验证系统功能
5. 记录恢复日志
```

---

**文档版本**: v1.0  
**最后更新**: 2024年1月  
**维护者**: Shrimp Agent开发团队  
**联系方式**: 项目GitHub仓库Issues